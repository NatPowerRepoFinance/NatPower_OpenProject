<%#-- copyright
OpenProject is an open source project management software.
Copyright (C) the OpenProject GmbH

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License version 3.

OpenProject is a fork of ChiliProject, which is a fork of Redmine. The copyright follows:
Copyright (C) 2006-2013 Jean-Philippe Lang
Copyright (C) 2010-2013 the ChiliProject Team

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

See COPYRIGHT and LICENSE files for more details.

++#%>

<%# Helper method to format API values %>
<% def format_api_value(key, value)
  case value
  when TrueClass
    '<span style="color: #1a7f37; font-weight: 600;">✓ Yes</span>'.html_safe
  when FalseClass
    '<span style="color: #cf222e;">✗ No</span>'.html_safe
  when Numeric
    if key.to_s.downcase.include?('date') || key.to_s.downcase.include?('time')
      begin
        Time.parse(value.to_s).strftime("%B %d, %Y at %I:%M %p")
      rescue
        value.to_s
      end
    elsif key.to_s.downcase.include?('mw') || key.to_s.downcase.include?('acre') || key.to_s.downcase.include?('parcel')
      number_with_precision(value, precision: 2, delimiter: ',')
    else
      number_with_delimiter(value)
    end
  when String
    if value.match?(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)
      begin
        Time.parse(value).strftime("%B %d, %Y at %I:%M %p")
      rescue
        value
      end
    else
      value.present? ? value : '<span style="color: #656d76; font-style: italic;">—</span>'.html_safe
    end
  when Array
    if value.empty?
      '<span style="color: #656d76; font-style: italic;">—</span>'.html_safe
    else
      value.map(&:to_s).join(", ")
    end
  when Hash
    value.to_json
  when nil
    '<span style="color: #656d76; font-style: italic;">—</span>'.html_safe
  else
    value.to_s.present? ? value.to_s : '<span style="color: #656d76; font-style: italic;">—</span>'.html_safe
  end
end %>

<%=
  render Primer::OpenProject::PageHeader.new do |header|
    header.with_title { "PDAs" }
    header.with_breadcrumbs(
      [{ href: project_overview_path(@project.id), text: @project.name },
       { href: project_settings_general_path(@project.id), text: I18n.t("label_project_settings") },
       "PDAs"]
    )
  end
%>

<% if @pda_nf.errors.any? %>
  <%= error_messages_for(@pda_nf) %>
<% end %>

<% if params[:id].present? && @pda_nf.persisted? %>
  <%# Show view for a specific PDA NF %>
  <div class="generic-form">
    <fieldset class="form--fieldset">
      <legend class="form--fieldset-legend">PDA Details</legend>
      
      <div class="form--field">
        <label class="form--label">PDA ID</label>
        <div class="form--field-container">
          <input type="text" value="<%= h(@pda_nf.pda_id) %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Initial Code</label>
        <div class="form--field-container">
          <input type="text" value="<%= h(@pda_nf.initial_code) %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Code</label>
        <div class="form--field-container">
          <input type="text" value="<%= h(@pda_nf.code) %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Project Manager GUID</label>
        <div class="form--field-container">
          <input type="text" value="<%= h(@pda_nf.project_manager_guid) if @pda_nf.project_manager_guid.present? %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Planning Manager GUID</label>
        <div class="form--field-container">
          <input type="text" value="<%= h(@pda_nf.planning_manager_guid) if @pda_nf.planning_manager_guid.present? %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Land Manager GUID</label>
        <div class="form--field-container">
          <input type="text" value="<%= h(@pda_nf.land_manager_guid) if @pda_nf.land_manager_guid.present? %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Senior Dev Manager GUID</label>
        <div class="form--field-container">
          <input type="text" value="<%= h(@pda_nf.senior_dev_manager_guid) if @pda_nf.senior_dev_manager_guid.present? %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Technology</label>
        <div class="form--field-container">
          <textarea readonly class="form--text-area" rows="3"><%= h(@pda_nf.technology) if @pda_nf.technology.present? %></textarea>
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">MW BESS</label>
        <div class="form--field-container">
          <input type="text" value="<%= @pda_nf.mw_bess %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">MW Solar</label>
        <div class="form--field-container">
          <input type="text" value="<%= @pda_nf.mw_solar %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">MW Wind</label>
        <div class="form--field-container">
          <input type="text" value="<%= @pda_nf.mw_wind %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">MW Hydrogen</label>
        <div class="form--field-container">
          <input type="text" value="<%= @pda_nf.mw_hydrogen %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">MW Hydroelectric</label>
        <div class="form--field-container">
          <input type="text" value="<%= @pda_nf.mw_hydroelectric %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">MW Other</label>
        <div class="form--field-container">
          <input type="text" value="<%= @pda_nf.mw_other %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">MW Other Description</label>
        <div class="form--field-container">
          <input type="text" value="<%= h(@pda_nf.mw_other_description) if @pda_nf.mw_other_description.present? %>" readonly class="form--text-field" />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Custom Substation</label>
        <div class="form--field-container">
          <input type="checkbox" <%= 'checked' if @pda_nf.custom_substation %> disabled />
        </div>
      </div>

      <div class="form--field">
        <label class="form--label">Transmission Substation</label>
        <div class="form--field-container">
          <input type="checkbox" <%= 'checked' if @pda_nf.transmisson_substation %> disabled />
        </div>
      </div>

      <div class="form--field">
        <%= link_to t(:button_edit), edit_project_settings_pda_nf_path(@project, @pda_nf), class: "button -primary" %>
        <%= link_to t(:button_back), project_settings_pda_nfs_path(@project), class: "button" %>
      </div>
    </fieldset>
  </div>

  <%# Display API Data %>
  <% if @pda_api_data.present? %>
    <div class="generic-form" style="margin-top: 2rem;">
      <fieldset class="form--fieldset">
        <legend class="form--fieldset-legend">PDA API Data</legend>
        
        <%# Display main PDA fields in a table %>
        <div class="generic-table--container" style="margin-bottom: 2rem;">
          <div class="generic-table--results-container">
            <table class="generic-table">
              <thead>
                <tr>
                  <th style="width: 30%;">Field</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                <% @pda_api_data.each do |key, value| %>
                  <% next if key == "negotiationRel" || value.nil? %>
                  <% next if value.is_a?(Hash) && value.empty? %>
                  <% next if value.is_a?(Array) && value.empty? %>
                  
                  <% display_value = format_api_value(key, value) %>
                  
                  <tr>
                    <td class="field-name" style="background-color: #f6f8fa; font-weight: 600; color: #24292f;"><%= key.to_s.humanize %></td>
                    <td style="word-break: break-word;"><%= display_value.html_safe %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>

        <%# Display Negotiation Relations in hierarchical tables %>
        <% if @pda_api_data["negotiationRel"].present? && @pda_api_data["negotiationRel"].is_a?(Array) %>
          <div style="margin-top: 2rem;">
            <h3 class="form--fieldset-legend" style="margin-bottom: 1rem;">Land Negotiations</h3>
            <% @pda_api_data["negotiationRel"].each_with_index do |negotiation, neg_index| %>
              <% negotiation_name = negotiation["name"] || negotiation["code"] || "Negotiation #{neg_index + 1}" %>
              <%= render(Primer::OpenProject::CollapsibleSection.new(collapsed: true, display: :block, mb: 3)) do |section| %>
                <% section.with_title do %>
                  <%= negotiation_name %>
                  <% if negotiation["code"].present? && negotiation["code"] != negotiation_name %>
                    <span style="color: #656d76; font-weight: normal; margin-left: 0.5rem;">(<%= negotiation["code"] %>)</span>
                  <% end %>
                <% end %>
                <% section.with_collapsible_content do %>
                  <%# Negotiation details table %>
                  <div class="generic-table--container" style="margin-bottom: 1rem;">
                    <div class="generic-table--results-container">
                      <table class="generic-table">
                        <thead>
                          <tr>
                            <th style="width: 30%; background-color: #f6f8fa;">Field</th>
                            <th style="background-color: #f6f8fa;">Value</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% negotiation.each do |key, value| %>
                            <% next if key == "titleNo" || value.nil? %>
                            <% next if value.is_a?(Hash) && value.empty? %>
                            <% next if value.is_a?(Array) && value.empty? %>
                            
                            <% display_value = format_api_value(key, value) %>
                            
                            <tr>
                              <td class="field-name" style="background-color: #f6f8fa; font-weight: 600; color: #24292f;"><%= key.to_s.humanize %></td>
                              <td style="word-break: break-word;"><%= display_value.html_safe %></td>
                            </tr>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <%# Display Title Numbers in nested collapsible table %>
                  <% if negotiation["titleNo"].present? && negotiation["titleNo"].is_a?(Array) %>
                    <%= render(Primer::OpenProject::CollapsibleSection.new(collapsed: true, display: :block, mb: 2)) do |title_section| %>
                      <% title_section.with_title do %>
                        Title Numbers (<%= negotiation["titleNo"].count %>)
                      <% end %>
                      <% title_section.with_collapsible_content do %>
                        <div class="generic-table--container">
                          <div class="generic-table--results-container">
                            <table class="generic-table">
                              <thead>
                                <tr>
                                  <% if negotiation["titleNo"].any? %>
                                    <% negotiation["titleNo"].first.keys.each do |key| %>
                                      <th style="background-color: #f6f8fa;"><%= key.to_s.humanize %></th>
                                    <% end %>
                                  <% end %>
                                </tr>
                              </thead>
                              <tbody>
                                <% negotiation["titleNo"].each do |title_no| %>
                                  <tr>
                                    <% title_no.each do |key, value| %>
                                      <% display_value = format_api_value(key, value) %>
                                      <td style="word-break: break-word;"><%= display_value.html_safe %></td>
                                    <% end %>
                                  </tr>
                                <% end %>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </fieldset>
    </div>
  <% elsif params[:id].present? && @pda_nf.pda_id.present? %>
    <div class="generic-form" style="margin-top: 2rem;">
      <fieldset class="form--fieldset">
        <legend class="form--fieldset-legend">PDA API Data</legend>
        <p class="form--field">
          <%= t(:notice_no_data_available) || "No API data available for this PDA." %>
        </p>
      </fieldset>
    </div>
  <% end %>
<% elsif current_user.allowed_in_project?(:edit_project, @project) %>
  <%= labelled_tabular_form_for @pda_nf,
                                url: project_settings_pda_nfs_path(@project),
                                html: { class: "form" } do |f| %>
    <fieldset class="form--fieldset">
      <legend class="form--fieldset-legend">New PDA</legend>
      
      <div class="form--field -required">
        <%= f.text_field :pda_id,
                          required: true,
                          container_class: "-middle",
                          label: "PDA ID" %>
      </div>

      <div class="form--field -required">
        <%= f.text_field :initial_code,
                          required: true,
                          container_class: "-middle",
                          label: "Initial Code" %>
      </div>

      <div class="form--field -required">
        <%= f.text_field :code,
                          required: true,
                          container_class: "-middle",
                          label: "Code" %>
      </div>

      <div class="form--field">
        <%= f.text_field :project_manager_guid,
                          container_class: "-middle",
                          label: "Project Manager GUID" %>
      </div>

      <div class="form--field">
        <%= f.text_field :planning_manager_guid,
                          container_class: "-middle",
                          label: "Planning Manager GUID" %>
      </div>

      <div class="form--field">
        <%= f.text_field :land_manager_guid,
                          container_class: "-middle",
                          label: "Land Manager GUID" %>
      </div>

      <div class="form--field">
        <%= f.text_field :senior_dev_manager_guid,
                          container_class: "-middle",
                          label: "Senior Dev Manager GUID" %>
      </div>

      <div class="form--field">
        <%= f.text_area :technology,
                        rows: 3,
                        container_class: "-middle",
                        label: "Technology" %>
      </div>

      <div class="form--field">
        <%= f.text_field :mw_bess,
                          container_class: "-middle",
                          label: "MW BESS",
                          type: "number",
                          step: "0.01" %>
      </div>

      <div class="form--field">
        <%= f.text_field :mw_solar,
                          container_class: "-middle",
                          label: "MW Solar",
                          type: "number",
                          step: "0.01" %>
      </div>

      <div class="form--field">
        <%= f.text_field :mw_wind,
                          container_class: "-middle",
                          label: "MW Wind",
                          type: "number",
                          step: "0.01" %>
      </div>

      <div class="form--field">
        <%= f.text_field :mw_hydrogen,
                          container_class: "-middle",
                          label: "MW Hydrogen",
                          type: "number",
                          step: "0.01" %>
      </div>

      <div class="form--field">
        <%= f.text_field :mw_hydroelectric,
                          container_class: "-middle",
                          label: "MW Hydroelectric",
                          type: "number",
                          step: "0.01" %>
      </div>

      <div class="form--field">
        <%= f.text_field :mw_other,
                          container_class: "-middle",
                          label: "MW Other",
                          type: "number",
                          step: "0.01" %>
      </div>

      <div class="form--field">
        <%= f.text_field :mw_other_description,
                          container_class: "-middle",
                          label: "MW Other Description" %>
      </div>

      <div class="form--field">
        <%= f.check_box :custom_substation,
                        container_class: "-middle",
                        label: "Custom Substation" %>
      </div>

      <div class="form--field">
        <%= f.check_box :transmisson_substation,
                        container_class: "-middle",
                        label: "Transmission Substation" %>
      </div>

      <div class="form--field">
        <%= f.button t(:button_create), class: "button -primary -with-icon icon-checkmark" %>
      </div>
    </fieldset>
  <% end %>
<% end %>

<% if @pda_nfs.present? && @pda_nfs.any? %>
  <div class="generic-table--container">
    <div class="generic-table--results-container">
      <table class="generic-table">
        <colgroup>
          <col opHighlightCol>
          <col>
          <col>
          <col>
          <col>
        </colgroup>
        <thead>
          <tr>
            <th>
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span>PDA ID</span>
                </div>
              </div>
            </th>
            <th>
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span>Code</span>
                </div>
              </div>
            </th>
            <th>
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span>Technology</span>
                </div>
              </div>
            </th>
            <th>
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span>Total MW</span>
                </div>
              </div>
            </th>
            <th>
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span><%= t(:label_created_on) %></span>
                </div>
              </div>
            </th>
            <% if current_user.allowed_in_project?(:edit_project, @project) %>
              <th><div class="generic-table--empty-header"></div></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @pda_nfs.each do |pda_nf| %>
            <tr>
              <td class="pda_id"><%= h(pda_nf.pda_id) %></td>
              <td class="code"><%= h(pda_nf.code) %></td>
              <td class="technology"><%= h(pda_nf.technology) if pda_nf.technology.present? %></td>
              <td class="total_mw">
                <%= number_with_precision(
                      (pda_nf.mw_bess || 0) + (pda_nf.mw_solar || 0) + (pda_nf.mw_wind || 0) + 
                      (pda_nf.mw_hydrogen || 0) + (pda_nf.mw_hydroelectric || 0) + (pda_nf.mw_other || 0),
                      precision: 2
                    ) %>
              </td>
              <td class="created_date"><%= format_time(pda_nf.created_date) if pda_nf.created_date %></td>
              <% if current_user.allowed_in_project?(:edit_project, @project) %>
                <td class="buttons">
                  <%= link_to "",
                              project_settings_pda_nf_path(@project, pda_nf),
                              data: {
                                turbo_method: :delete,
                                turbo_confirm: t(:text_are_you_sure)
                              },
                              class: "icon icon-delete",
                              title: t(:button_delete) %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <%= no_results_box %>
<% end %>
